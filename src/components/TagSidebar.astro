---
import { getCollection } from "astro:content";
import { kUrlBase } from "$consts";
import { ThemeToggle } from "$components";

const posts = await getCollection("blog");
const tagMap = new Map();
for (const post of posts) {
  if (post.data.tags) {
    for (const tag of post.data.tags) {
      tagMap.set(tag, (tagMap.get(tag) || 0) + 1);
    }
  }
}
const tags = Array.from(tagMap.entries()).sort((a, b) => b[1] - a[1]);
---
<aside class="tag-sidebar">
  <h3 class="tag-header">Tags <span class="toggle-icon">▼</span></h3>
  <ul class="tags collapsed">
    {tags.map(([tag, count]) => (
      <li>
        <a href={`${kUrlBase}/article?search=${encodeURIComponent(tag)}`}>{tag}</a>
        <span class="tag-count">({count})</span>
      </li>
    ))}
  </ul>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const tagHeader = document.querySelector('.tag-header');
    const tagList = document.querySelector('.tags');
    const toggleIcon = document.querySelector('.toggle-icon');
    
    if (tagHeader && tagList && toggleIcon) {
      tagHeader.addEventListener('click', () => {
        tagList.classList.toggle('collapsed');
        toggleIcon.textContent = tagList.classList.contains('collapsed') ? '▼' : '▲';
      });
    }
  });
</script>
<style>
.theme-label {
  display: none;
}
.theme-toggle-container {
  display: none;
}

.tag-sidebar {
  position: sticky;
  top: 2.5em;
  left: 0;
  width: 100%;
  max-width: 16em;
  min-width: 8em;
  box-sizing: border-box;
  padding: 1.2em 1em 1em 1em;
  background: rgba(255, 255, 255, 0.38);
  border-radius: 1.2em;
  margin-bottom: 2em;
  box-shadow: 0 1px 8px 0 rgba(0,0,0,0.08);
  backdrop-filter: blur(18px) saturate(1.2);
  -webkit-backdrop-filter: blur(18px) saturate(1.2);
  border: 1px solid rgba(200,200,200,0.18);
  z-index: 10;
  transition: background 0.2s, width 0.3s ease;
  font-size: 1em;
}
@media (min-width: 900px) {
  .tag-sidebar {
    width: 20vw;
    max-width: 20vw;
    min-width: 12em;
  }
}
.tag-sidebar h3 {
  margin-top: 0;
  margin-bottom: 0.5em;
  font-size: 1.1em;
  color: var(--accent);
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.tag-sidebar .toggle-icon {
  font-size: 0.8em;
  transition: transform 0.3s ease;
}
.tag-sidebar .tags {
  list-style: none;
  padding: 0;
  margin: 0;
  max-height: 300px;
  overflow-y: auto;
  transition: max-height 0.3s ease, opacity 0.3s ease;
}
.tag-sidebar .tags.collapsed {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
}
.tag-sidebar .tags li {
  display: inline-block;
  margin: 0 0.5em 0.5em 0;
}
.tag-sidebar .tags a {
  text-decoration: none;
  color: var(--main-color);
  background: var(--raw-bg-color, rgba(101,117,133,0.10));
  padding: 0.1em 0.35em; /* 缩小为原来的一半 */
  border-radius: 2px; /* 缩小为原来的一半 */
  transition: background 0.2s, color 0.2s;
  font-size: 1em;
}
.tag-sidebar .tags a:hover {
  background: var(--accent);
  color: #fff;
}
.tag-sidebar .tag-count {
  font-size: 0.45em; /* 缩小为原来的一半 */
  color: var(--gray-color);
  margin-left: 0.1em; /* 缩小为原来的一半 */
}
</style>
